<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UniMAP Bus Tracker - Live</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        #map { height: 100vh; width: 100%; }
        body, html { margin: 0; padding: 0; overflow: hidden; font-family: 'Inter', sans-serif; }
        .bus-marker {
            transition: all 1s linear; /* Membuat pergerakan bas nampak 'smooth' */
        }
    </style>
</head>

<body class="bg-gray-100">

<div id="app" class="relative">

    <header class="bg-blue-900 text-white shadow-lg p-4 flex justify-between items-center fixed top-0 w-full z-20">
        <div>
            <h1 class="text-xl font-bold">UniMAP Bus Tracker</h1>
            <p class="text-xs opacity-75">Sistem Penjejakan Bas Kampus</p>
        </div>
        <div class="text-right">
            <span id="update-time" class="text-xs block">Menunggu data...</span>
            <span id="status-pill" class="inline-block px-2 py-1 rounded-full text-[10px] font-bold bg-yellow-500 text-black">OFFLINE</span>
        </div>
    </header>

    <div id="map" class="z-10"></div>

    <div class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[90%] sm:w-[400px] bg-white shadow-2xl rounded-2xl z-30 overflow-hidden border border-gray-200">
        <div class="bg-blue-800 p-3 text-white text-center font-bold">
            MAKLUMAT BAS SEMASA
        </div>
        <div class="p-4 grid grid-cols-2 gap-4 text-sm">
            <div class="bg-gray-50 p-2 rounded-lg border">
                <p class="text-gray-500 text-[10px] uppercase font-bold">Latitud</p>
                <p id="lat-display" class="text-blue-700 font-mono font-bold">0.000000</p>
            </div>
            <div class="bg-gray-50 p-2 rounded-lg border">
                <p class="text-gray-500 text-[10px] uppercase font-bold">Longitud</p>
                <p id="lng-display" class="text-blue-700 font-mono font-bold">0.000000</p>
            </div>
            <div class="bg-blue-50 p-2 rounded-lg border border-blue-200">
                <p class="text-blue-500 text-[10px] uppercase font-bold">Kelajuan</p>
                <p><span id="speed-display" class="text-lg font-bold">0.0</span> <span class="text-xs">km/j</span></p>
            </div>
            <div class="bg-green-50 p-2 rounded-lg border border-green-200">
                <p class="text-green-600 text-[10px] uppercase font-bold">Satelit (Fix)</p>
                <p><span id="sat-display" class="text-lg font-bold">0</span> <span class="text-xs">Sats</span></p>
            </div>
        </div>
        <div class="bg-gray-100 p-2 text-[10px] text-center text-gray-400">
            Terakhir dikemas kini: <span id="time-data-display">N/A</span>
        </div>
    </div>

</div>

<script>
/* ============================================================
   KONFIGURASI PERANTI (SESUAIKAN DENGAN DASHBOARD ANDA)
   ============================================================ */
const FAVORIOT_API_URL = "https://apiv2.favoriot.com/v2/streams";
const DEVICE_DEVELOPER_ID = "bustrackerunimap@s231291233"; // ID Baru anda
const FAVORIOT_API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6InMyMzEyOTEyMzMiLCJyZWFkX3dyaXRlIjpmYWxzZSwiaWF0IjoxNzY2NTAyOTg4fQ.x_YbUrMSvLdY_f-Dc9f-DmoUOY_by3HclOoTXC8_rTo";

const FETCH_INTERVAL = 5000; // Kemas kini setiap 5 saat

/* ============================================================
   MAP & ICON SETUP
   ============================================================ */
const map = L.map('map').setView([6.4632, 100.2709], 15); // Default ke UniMAP Pauh Putra

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// Ikon Bas Custom
const busIcon = L.divIcon({
    className: 'bus-marker',
    html: `
        <div class="relative">
            <div class="bg-blue-600 w-10 h-10 rounded-full flex items-center justify-center shadow-xl border-4 border-white">
                <span class="text-xl">ðŸšŒ</span>
            </div>
            <div class="absolute -top-1 -right-1 w-4 h-4 bg-green-500 rounded-full border-2 border-white animate-pulse"></div>
        </div>
    `,
    iconSize: [40, 40],
    iconAnchor: [20, 20]
});

let busMarker = null;

/* ============================================================
   FUNGSI AMBIL DATA DARI FAVORIOT
   ============================================================ */
async function updateBusData() {
    try {
        const response = await fetch(`${FAVORIOT_API_URL}?device_developer_id=${DEVICE_DEVELOPER_ID}&max=1`, {
            method: 'GET',
            headers: {
                "apikey": FAVORIOT_API_KEY,
                "Content-Type": "application/json"
            }
        });

        if (!response.ok) throw new Error("Gagal menyambung ke server");

        const result = await response.json();
        const latestData = result.streams?.[0];

        if (latestData && latestData.data) {
            const { latitude, longitude, speed, satellites } = latestData.data;
            const timestamp = latestData.created_at;

            // Kemas kini Peta & Marker
            const position = [latitude, longitude];
            
            if (!busMarker) {
                busMarker = L.marker(position, { icon: busIcon }).addTo(map);
                map.setView(position, 16);
            } else {
                busMarker.setLatLng(position);
            }

            // Kemas kini UI
            document.getElementById('lat-display').textContent = latitude.toFixed(6);
            document.getElementById('lng-display').textContent = longitude.toFixed(6);
            document.getElementById('speed-display').textContent = speed ? speed.toFixed(1) : "0.0";
            document.getElementById('sat-display').textContent = satellites || "0";
            
            // Format Masa
            const dateObj = new Date(timestamp);
            document.getElementById('time-data-display').textContent = dateObj.toLocaleString('ms-MY');
            document.getElementById('update-time').textContent = `Sync: ${new Date().toLocaleTimeString()}`;

            // Update Status Pill
            const statusPill = document.getElementById('status-pill');
            statusPill.textContent = "LIVE";
            statusPill.className = "inline-block px-2 py-1 rounded-full text-[10px] font-bold bg-green-500 text-white";

        } else {
            console.warn("Data stream kosong.");
        }

    } catch (error) {
        console.error("Ralat:", error);
        const statusPill = document.getElementById('status-pill');
        statusPill.textContent = "ERROR";
        statusPill.className = "inline-block px-2 py-1 rounded-full text-[10px] font-bold bg-red-600 text-white";
    }
}

// Jalankan loop
updateBusData();
setInterval(updateBusData, FETCH_INTERVAL);

</script>

</body>
</html>