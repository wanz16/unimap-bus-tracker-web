<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UNIMAP Bus Tracker</title>
    <!-- Muatkan Tailwind CSS dari CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Muatkan Library Leaflet untuk Peta (Wajib) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        /* Tetapkan ketinggian peta */
        #map { height: 100vh; width: 100%; }
        /* Peta dalam mod tetingkap penuh */
        body, html { margin: 0; padding: 0; overflow: hidden; font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Kontena Utama Laman Web -->
    <div id="app" class="relative">
        
        <!-- Bar Navigasi Atas -->
        <header class="bg-blue-800 text-white shadow-lg p-4 flex justify-between items-center fixed top-0 w-full z-20">
            <h1 class="text-xl font-bold">UNIMAP Bus Tracker</h1>
            <div class="text-sm">
                <span id="update-time" class="opacity-75">Loading...</span>
            </div>
        </header>

        <!-- Peta Leaflet (Wajib ada ID 'map') -->
        <div id="map" class="relative z-10"></div>

        <!-- Panel Maklumat (Overlay) -->
        <div class="fixed bottom-0 left-0 right-0 p-4 bg-white shadow-2xl rounded-t-xl z-30 sm:w-1/3 sm:left-1/2 sm:transform sm:-translate-x-1/2 md:w-1/4">
            <h2 class="text-lg font-semibold text-blue-800 mb-2">Maklumat Lokasi Bas</h2>
            <div id="location-info" class="text-sm space-y-1">
                <p><strong>Status:</strong> <span id="status" class="text-yellow-600">Menghubungkan ke API...</span></p>
                <p><strong>Latitud:</strong> <span id="lat-display">N/A</span></p>
                <p><strong>Longitud:</strong> <span id="lng-display">N/A</span></p>
                <p><strong>Masa Data:</strong> <span id="time-data-display">N/A</span></p>
            </div>
        </div>

    </div>

    <script>
        // =========================================================================
        // JAVASCRIPT UTAMA UNTUK PETA & MENGAMBIL DATA API
        // =========================================================================

        // --- KONFIGURASI PENTING ---
        // GANTIKAN ini dengan URL Cloudflare Worker anda.
        // CONTOH: "https://nama-worker-anda.workers.dev"
        const WORKER_API_URL = "https://unimap.s231291233.workers.dev"; // <-- UBAH INI!
        const FETCH_INTERVAL = 5000; // Kemas kini setiap 5 saat (5000 milisaat)
        
        // Koordinat lalai (Pusat UniMAP atau kawasan operasi bas)
        const DEFAULT_CENTER = [6.4632, 100.2709]; // Lokasi UniMAP Pauh Putra
        const DEFAULT_ZOOM = 14;

        // Inisialisasi Peta
        const map = L.map('map').setView(DEFAULT_CENTER, DEFAULT_ZOOM);

        // Tambah Tile Layer (Peta Dasar)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Cipta Marker untuk Bas
        let busMarker = null;

        // Icon Bas Kustom
        const busIcon = L.divIcon({
            className: 'custom-bus-icon',
            html: '<div class="bg-blue-600 rounded-full w-8 h-8 flex items-center justify-center shadow-lg transform transition-transform duration-500 ease-in-out hover:scale-110"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a1 1 0 011 1v1h3a1 1 0 011 1v2a1 1 0 01-2 0V5h-1V3a1 1 0 01-2 0v2h-1V3a1 1 0 01-2 0v2H6a1 1 0 01-2 0V5a1 1 0 011-1h3V3a1 1 0 011-1zM4 10a1 1 0 011-1h10a1 1 0 011 1v7a1 1 0 01-1 1H5a1 1 0 01-1-1v-7zM7 13a1 1 0 011-1h4a1 1 0 011 1v2a1 1 0 01-1 1H8a1 1 0 01-1-1v-2z"/></svg></div>',
            iconSize: [32, 32],
            iconAnchor: [16, 16]
        });

        // --- FUNGSI UTAMA UNTUK MENDAPATKAN LOKASI ---
        async function fetchBusLocation() {
            document.getElementById('status').textContent = 'Mengambil data...';
            document.getElementById('status').classList.remove('text-red-600', 'text-green-600');
            document.getElementById('status').classList.add('text-yellow-600');
            
            try {
                // Panggil endpoint GET /get_location dari Worker
                const response = await fetch(`${WORKER_API_URL}/get_location`);
                const data = await response.json();

                // Semak sama ada data latitud dan longitud wujud
                if (data && typeof data.latitude === 'number' && typeof data.longitude === 'number') {
                    const lat = data.latitude;
                    const lng = data.longitude;
                    const timestamp = data.timestamp;

                    const newLatLng = [lat, lng];

                    // Kemas kini atau Cipta Marker
                    if (busMarker) {
                        // Jika marker sedia ada, alihkannya dengan lancar (hanya dalam UI)
                        busMarker.setLatLng(newLatLng);
                    } else {
                        // Cipta marker baharu
                        busMarker = L.marker(newLatLng, { icon: busIcon }).addTo(map);
                        // Paparkan popup
                        busMarker.bindPopup("<b>Bas UniMAP</b><br>Lokasi Terkini.").openPopup();
                        // Alihkan pandangan peta ke lokasi bas pertama
                        map.setView(newLatLng, DEFAULT_ZOOM);
                    }
                    
                    // Kemas kini info panel
                    document.getElementById('status').textContent = 'Dalam talian (Bergerak)';
                    document.getElementById('status').classList.remove('text-yellow-600');
                    document.getElementById('status').classList.add('text-green-600');
                    
                    document.getElementById('lat-display').textContent = lat.toFixed(6);
                    document.getElementById('lng-display').textContent = lng.toFixed(6);
                    
                    // Format masa
                    if (timestamp) {
                        const date = new Date(timestamp);
const opsiMasa = {
    timeZone: 'Asia/Kuala_Lumpur',
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
    hour12: false
};
document.getElementById('time-data-display').textContent = date.toLocaleString('ms-MY', opsiMasa);
                    }

                } else {
                    // Jika API membalas tanpa data lokasi
                    document.getElementById('status').textContent = 'Menunggu data GPS...';
                    document.getElementById('status').classList.remove('text-green-600');
                    document.getElementById('status').classList.add('text-yellow-600');
                    document.getElementById('lat-display').textContent = 'N/A';
                    document.getElementById('lng-display').textContent = 'N/A';
                }

                // Kemas kini masa capaian laman web (bukan masa data)
                document.getElementById('update-time').textContent = `Dikemas kini pada: ${new Date().toLocaleTimeString()}`;

            } catch (error) {
                console.error("Fetch Error:", error);
                document.getElementById('status').textContent = `Ralat API: ${error.message}`;
                document.getElementById('status').classList.remove('text-green-600', 'text-yellow-600');
                document.getElementById('status').classList.add('text-red-600');
            }
        }

        // Mulakan pengulang untuk mengemas kini lokasi secara berkala
        fetchBusLocation(); // Panggil sekali pada mulanya
        setInterval(fetchBusLocation, FETCH_INTERVAL);
        
    </script>
</body>

</html>
