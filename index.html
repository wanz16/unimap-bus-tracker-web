<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UNIMAP Bus Tracker</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        #map { height: 100vh; width: 100%; }
        body, html { margin: 0; padding: 0; overflow: hidden; font-family: 'Inter', sans-serif; }
    </style>
</head>

<body class="bg-gray-100">

<div id="app" class="relative">

    <!-- Header -->
    <header class="bg-blue-800 text-white shadow-lg p-4 flex justify-between items-center fixed top-0 w-full z-20">
        <h1 class="text-xl font-bold">UNIMAP Bus Tracker</h1>
        <span id="update-time" class="text-sm opacity-80">Loading...</span>
    </header>

    <!-- Map -->
    <div id="map" class="z-10"></div>

    <!-- Info Panel -->
    <div class="fixed bottom-0 left-0 right-0 p-4 bg-white shadow-2xl rounded-t-xl z-30 sm:w-1/3 sm:left-1/2 sm:-translate-x-1/2">
        <h2 class="text-lg font-semibold text-blue-800 mb-2">Maklumat Lokasi Bas</h2>
        <div class="text-sm space-y-1">
            <p><strong>Status:</strong> <span id="status" class="text-yellow-600">Menyambung ke Favoriot...</span></p>
            <p><strong>Latitud:</strong> <span id="lat-display">N/A</span></p>
            <p><strong>Longitud:</strong> <span id="lng-display">N/A</span></p>
            <p><strong>Masa Data:</strong> <span id="time-data-display">N/A</span></p>
        </div>
    </div>

</div>

<script>
/* ============================================================
   KONFIGURASI FAVORIOT
   ============================================================ */

const FAVORIOT_API_URL = "https://api.favoriot.com/v2/streams";
const FAVORIOT_API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6InMyMzEyOTEyMzMiLCJyZWFkX3dyaXRlIjpmYWxzZSwiaWF0IjoxNzY2NTAyOTg4fQ.x_YbUrMSvLdY_f-Dc9f-DmoUOY_by3HclOoTXC8_rTo";
const DEVICE_DEVELOPER_ID = "UNIMAP_Bus@s231291233";

const FETCH_INTERVAL = 5000;

/* ============================================================
   MAP SETUP
   ============================================================ */

const DEFAULT_CENTER = [6.4632, 100.2709]; // UniMAP Pauh Putra
const DEFAULT_ZOOM = 14;

const map = L.map('map').setView(DEFAULT_CENTER, DEFAULT_ZOOM);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let busMarker = null;

const busIcon = L.divIcon({
    className: 'custom-bus-icon',
    html: `
        <div class="bg-blue-600 w-8 h-8 rounded-full flex items-center justify-center shadow-lg">
            ðŸšŒ
        </div>
    `,
    iconSize: [32, 32],
    iconAnchor: [16, 16]
});

/* ============================================================
   FETCH DATA FROM FAVORIOT
   ============================================================ */

async function fetchBusLocation() {

    document.getElementById('status').textContent = 'Mengambil data...';
    document.getElementById('status').className = 'text-yellow-600';

    try {
        const response = await fetch(
            `${FAVORIOT_API_URL}?device_developer_id=${DEVICE_DEVELOPER_ID}&max=1`,
            {
                headers: {
                    "apikey": FAVORIOT_API_KEY,
                    "Content-Type": "application/json"
                }
            }
        );

        const json = await response.json();
        const stream = json.streams?.[0];

        if (!stream || !stream.data?.latitude || !stream.data?.longitude) {
            throw new Error("Tiada data GPS");
        }

        const lat = stream.data.latitude;
        const lng = stream.data.longitude;
        const timestamp = stream.created_at;

        const newLatLng = [lat, lng];

        if (busMarker) {
            busMarker.setLatLng(newLatLng);
            map.panTo(newLatLng, { animate: true, duration: 1 });
        } else {
            busMarker = L.marker(newLatLng, { icon: busIcon }).addTo(map);
            map.setView(newLatLng, DEFAULT_ZOOM);
        }

        document.getElementById('status').textContent = 'Dalam talian';
        document.getElementById('status').className = 'text-green-600';

        document.getElementById('lat-display').textContent = lat.toFixed(6);
        document.getElementById('lng-display').textContent = lng.toFixed(6);

        document.getElementById('time-data-display').textContent =
            new Date(timestamp).toLocaleString('ms-MY', {
                timeZone: 'Asia/Kuala_Lumpur',
                hour12: false
            });

        document.getElementById('update-time').textContent =
            `Dikemas kini: ${new Date().toLocaleTimeString('ms-MY')}`;

    } catch (error) {
        console.error(error);
        document.getElementById('status').textContent = 'Gagal sambung Favoriot';
        document.getElementById('status').className = 'text-red-600';
    }
}

/* ============================================================
   START LOOP
   ============================================================ */

fetchBusLocation();
setInterval(fetchBusLocation, FETCH_INTERVAL);

</script>

</body>
</html>
